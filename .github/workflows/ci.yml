name: ğŸš€ CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  validate:
    name: ğŸ” Validar CÃ³digo
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v3
      
    - name: ğŸ” Validar estructura de archivos
      run: |
        echo "Validando estructura de archivos..."
        ls -la google-apps-script/
        echo "âœ… Estructura de archivos vÃ¡lida"
        
    - name: ğŸ“‹ Validar documentaciÃ³n
      run: |
        echo "Validando documentaciÃ³n..."
        test -f README.md && echo "âœ… README.md encontrado"
        test -f INSTALLATION.md && echo "âœ… INSTALLATION.md encontrado"
        test -f TECHNICAL_DOCS.md && echo "âœ… TECHNICAL_DOCS.md encontrado"
        test -f CONTRIBUTING.md && echo "âœ… CONTRIBUTING.md encontrado"
        test -f CHANGELOG.md && echo "âœ… CHANGELOG.md encontrado"
        test -f LICENSE && echo "âœ… LICENSE encontrado"
        echo "âœ… DocumentaciÃ³n completa"
        
    - name: ğŸ”§ Validar configuraciÃ³n
      run: |
        echo "Validando configuraciÃ³n..."
        test -f project-config.json && echo "âœ… project-config.json encontrado"
        test -f package.json && echo "âœ… package.json encontrado"
        echo "âœ… ConfiguraciÃ³n vÃ¡lida"
        
    - name: ğŸ“± Validar archivos .gs
      run: |
        echo "Validando archivos de Google Apps Script..."
        for file in google-apps-script/*.gs; do
          if [ -f "$file" ]; then
            echo "âœ… $(basename "$file") encontrado"
            # Validar sintaxis bÃ¡sica de JavaScript
            if grep -q "function " "$file"; then
              echo "  âœ… Contiene funciones"
            fi
            if grep -q "//" "$file"; then
              echo "  âœ… Contiene comentarios"
            fi
          fi
        done
        echo "âœ… Archivos .gs vÃ¡lidos"

  test:
    name: ğŸ§ª Ejecutar Pruebas
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v3
      
    - name: ğŸ§ª Pruebas de sintaxis
      run: |
        echo "Ejecutando pruebas de sintaxis..."
        # Verificar que los archivos .gs no tengan errores de sintaxis obvios
        for file in google-apps-script/*.gs; do
          if [ -f "$file" ]; then
            echo "Probando $(basename "$file")..."
            # Verificar parÃ©ntesis balanceados
            if [ $(grep -o '(' "$file" | wc -l) -eq $(grep -o ')' "$file" | wc -l) ]; then
              echo "  âœ… ParÃ©ntesis balanceados"
            else
              echo "  âŒ ParÃ©ntesis desbalanceados"
              exit 1
            fi
            # Verificar llaves balanceadas
            if [ $(grep -o '{' "$file" | wc -l) -eq $(grep -o '}' "$file" | wc -l) ]; then
              echo "  âœ… Llaves balanceadas"
            else
              echo "  âŒ Llaves desbalanceadas"
              exit 1
            fi
          fi
        done
        echo "âœ… Pruebas de sintaxis completadas"
        
    - name: ğŸ“‹ Pruebas de documentaciÃ³n
      run: |
        echo "Ejecutando pruebas de documentaciÃ³n..."
        # Verificar que README tenga secciones importantes
        grep -q "## ğŸ“‹ CaracterÃ­sticas Principales" README.md && echo "âœ… CaracterÃ­sticas documentadas"
        grep -q "## ğŸš€ InstalaciÃ³n" README.md && echo "âœ… InstalaciÃ³n documentada"
        grep -q "## ğŸ“ Estructura del Sistema" README.md && echo "âœ… Estructura documentada"
        echo "âœ… Pruebas de documentaciÃ³n completadas"

  security:
    name: ğŸ”’ AnÃ¡lisis de Seguridad
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v3
      
    - name: ğŸ” Buscar informaciÃ³n sensible
      run: |
        echo "Analizando seguridad..."
        # Buscar posibles credenciales hardcodeadas
        if grep -r -i "password\|secret\|key\|token" google-apps-script/ --exclude-dir=.git; then
          echo "âš ï¸ Posibles credenciales encontradas, revisar manualmente"
        else
          echo "âœ… No se encontraron credenciales obvias"
        fi
        
        # Buscar URLs hardcodeadas
        if grep -r "https://" google-apps-script/ --exclude-dir=.git; then
          echo "âš ï¸ URLs hardcodeadas encontradas, revisar manualmente"
        else
          echo "âœ… No se encontraron URLs hardcodeadas"
        fi
        
        echo "âœ… AnÃ¡lisis de seguridad completado"

  build:
    name: ğŸ—ï¸ Construir Proyecto
    runs-on: ubuntu-latest
    needs: [validate, test, security]
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v3
      
    - name: ğŸ“¦ Crear paquete de distribuciÃ³n
      run: |
        echo "Creando paquete de distribuciÃ³n..."
        mkdir -p dist
        cp -r google-apps-script/ dist/
        cp README.md INSTALLATION.md TECHNICAL_DOCS.md CONTRIBUTING.md CHANGELOG.md LICENSE project-config.json package.json dist/
        tar -czf healthynola-pos-v1.0.0.tar.gz -C dist .
        echo "âœ… Paquete creado: healthynola-pos-v1.0.0.tar.gz"
        
    - name: ğŸ“¤ Subir artefactos
      uses: actions/upload-artifact@v3
      with:
        name: healthynola-pos-package
        path: healthynola-pos-v1.0.0.tar.gz

  deploy:
    name: ğŸš€ Desplegar
    runs-on: ubuntu-latest
    needs: [validate, test, security, build]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v3
      
    - name: ğŸ·ï¸ Crear release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ github.run_number }}
        release_name: Release v${{ github.run_number }}
        body: |
          ## ğŸš€ Nuevo Release
          
          ### Cambios
          - Ver [CHANGELOG.md](CHANGELOG.md) para detalles
          
          ### InstalaciÃ³n
          - Ver [INSTALLATION.md](INSTALLATION.md) para instrucciones
          
          ### DocumentaciÃ³n
          - [README.md](README.md) - GuÃ­a principal
          - [TECHNICAL_DOCS.md](TECHNICAL_DOCS.md) - DocumentaciÃ³n tÃ©cnica
        draft: false
        prerelease: false
